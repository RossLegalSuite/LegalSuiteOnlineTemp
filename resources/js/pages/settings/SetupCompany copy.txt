<template>

<div :id="id" class="card h-100 border-0">
    
    <div class="card-header">
        <div class="d-flex justify-content-between">
            <h3><i class="fa fa-cog mr-2"></i>System Settings</h3>
            <page-close-button @closeClicked="hide"/>
        </div>
    </div>



    <div class="card-body form-tab-body overflow-auto">

        <form-tabs :tabs="tabs"/>

        <div v-show="activeTab === 'General'" class="form-tab-content">
            <div class="row">

                <div class="col-xxl-6">
                    
                    <div class="form-group row">

                        <text-input _class="col-md-12" v-model="record.name" name="name" label="Name" :error="errors.name"/>

                    </div>

                    <div class="form-group row">

                        <text-input _class="col-md-12" v-model="record.tradingName" name="tradingName" label="Trading As" :error="errors.tradingName"
                                pop-over="<h4>The commercial or trading name of the Company.</h4>
                                <p>Many companies have a <em>trading name</em> which is their brand name or corporate identity and appears on client-facing documentation such as letters and invoices.</p>
                                <p>If your company has a trading name, insert it here, otherwise put the legal name of the company here.</p>"/>
                    </div>

                    <div class="form-group row">

                        <text-input _class="col-md-12" v-model="record.registrationNumber" name="registrationNumber" label="Registration Number" :error="errors.registrationNumber"/>

                    </div>

                    <div class="form-group row">

                        <text-input _class="col-md-12" v-model="record.website" name="website" label="Website" :error="errors.website"/>

                    </div>

                </div>

                <!-- <div class="col-xxl-6 mt-xxl-0 mt-xl-3">

                    <fieldset style="background: lightgrey;" class="mt-2 pt-3"><legend>Contact Details</legend>
                        
                        <company-numbers
                            :id="_uid + '-company-numbers-form'"
                            ref="company-numbers"
                            formRef="company-numbers"
                            :table-id="_uid + '-company-numbers-table'"
                            :lazyLoadFlag="true"
                            :searchInputFocus="false"
                        />
                        
                    </fieldset>

                </div> -->

            </div>

            <div class="row">
                <div class="col-xxl-6">
                
                    <fieldset  style="background: lightgrey;" class="mt-3"><legend>Postal Address</legend>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.postalLine1" name="postalLine1" label="Line 1" :error="errors.postalLine1"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.postalLine2" name="postalLine2" label="Line 2" :error="errors.postalLine2"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-9" v-model="record.postalLine3" name="postalLine3" label="Line 3" :error="errors.postalLine3"/>
                            <text-input _class="col-md-3" v-model="record.postalCode" name="postalCode" label="Code" :error="errors.postalCode"/>
                        </div>


                    </fieldset>

                </div>

                <div class="col-xxl-6 mt-xxl-0 mt-xl-3">

                    <fieldset  style="background: lightgrey;" class="mt-3"><legend>Physical Address</legend>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.physicalLine1" name="physicalLine1" label="Line 1" :error="errors.physicalLine1"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.physicalLine2" name="physicalLine2" label="Line 2" :error="errors.physicalLine2"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-9" v-model="record.physicalLine3" name="physicalLine3" label="Line 3" :error="errors.physicalLine3"/>
                            <text-input _class="col-md-3" v-model="record.physicalCode" name="physicalCode" label="Code" :error="errors.physicalCode"/>
                        </div>


                    </fieldset>

                </div>

            </div>

        </div>

        <div v-show="activeTab === 'LetterHead'" class="form-tab-content">
            <div v-show="!letterHeadPdfFile" class="row mt-3">

                <div class="col-md-12">

                    <letterhead-dropzone 
                        v-show="!letterHeadPdfFile"
                        id="company-letterhead-drop-zone-component" 
                        ref="company-letterhead-drop-zone-component" 
                        :options="letterHeadDropOptions" 
                        :useCustomSlot=true 
                        @vdropzone-error="letterHeadUploadError"
                        @vdropzone-success="letterHeadUploaded"
                    >
                        <div class="dropzone-custom-content cp">
                            <h1 class="text-primary" style="display:inline-block">Company Letterhead</h1>
                            <h2 style="display:inline-block">
                                <pop-over content="
                                    <h4>Company Letterhead</h4>
                                    <p>A letterhead can be used in documents generated by the program.</p> 
                                        <p>Instead of putting the letterhead in every Document Template, you can design your letterhead once (in Word) and then upload it here. 
                                        You can then insert it into a Document Template using a Component [letterhead].</p>
                                    <p>If your letterhead ever changes, you can replace it here and the documents will then use this new letterhead going forward.</p>" 
                                    :container="'#' + id"
                                />
                            </h2>

                            
                            <h3 class="text-success mt-5">Drag and drop your letterhead here</h3>
                            <div class="subtitle">...or click anywhere in this box to manually select a document</div>
                        </div>
                    </letterhead-dropzone>

                </div>

            </div>

            <div v-show="letterHeadPdfFile" class="row mt-3">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>Letterhead</h4>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-sm d-inline-block mr-2" @click="replaceLetterHead" title="Replace the Letterhead"><i class="fa fa-refresh mr-2"></i>Replace</button>
                            <button class="btn btn-primary btn-sm d-inline-block mr-2" @click="downloadLetterHead" title="Download the Letterhead"><i class="fa fa-download mr-2"></i>Download</button>
                            <button class="btn btn-danger btn-sm d-inline-block" @click="deleteLetterHead" title="Delete the Letterhead"><i class="fa fa-times mr-2"></i>Delete</button>
                        </div>
                    </div>
                </div>
            </div>


            <div v-show="letterHeadPdfFile" style="min-height:70vh" class="row">
                <div class="col-md-12">
                    <iframe class="iframe-container" id="setup-company-letterhead-pdf-iframe"></iframe>
                </div>
            </div>



        </div>

        <div v-show="activeTab === 'Logo'" class="form-tab-content">
            <div class="row">

                <div class="col-xxl-6 col-xl-10">

                    <fieldset class="mt-2"><legend>Logo</legend>

                        <logo-dropzone 
                            v-show="!record.logo"
                            id="company-logo-drop-zone-component" 
                            ref="company-logo-drop-zone-component" 
                            :options="logoDropOptions" 
                            :useCustomSlot=true 
                            @vdropzone-error="logoUploadError"
                            @vdropzone-success="logoUploaded"
                        >
                            <div class="dropzone-custom-content">
                                <h3 class="text-success">Drag and drop a file here</h3>
                                <div class="subtitle">...or click here to manually select a file</div>
                            </div>
                        </logo-dropzone>

                        <img v-show="record.logo" class="img-fluid border" style="max-height: 30vh;" :src="record.logo" alt="Company Logo">

                        <div v-show="record.logo" class="mt-3 text-right">
                            <button class="btn btn-success btn-sm d-inline-block mr-2" @click="replaceLogo" title="Change the Company logo"><i class="fa fa-refresh mr-2"></i>Replace</button>
                            <button class="btn btn-danger btn-sm d-inline-block" @click="deleteLogo" title="Delete the Company logo"><i class="fa fa-times mr-2"></i>Delete</button>
                        </div>


                    </fieldset>

                </div>

            </div>
        </div>

        <div v-show="activeTab === 'Colors'" class="form-tab-content">
            <div class="row">
                <div class="col-xxl-6">
                    <fieldset style="background: lightgrey;" class="mt-2"><legend>Fee Notes</legend>
                        <div class="form-group row">

                            <text-input
                            _class="col-md-8" 
                            label="Unposted Fees"
                            name="unpostedFeeBackgroundColor"
                            popOver="<h4>Unposted Fees</h4>
                                <p>You can set a <em>color</em> for Fee Notes which are <em><strong>Fees</strong></em> and have not been allocated to an Invoice, i.e. they are <strong>unposted</strong>.</p>
                                <p>These Fee Notes will then be displayed in this color which makes it easy to differentiate Fees from Disbursements and which have, and have not, been posted.</p>"
                            :popOverContainer="'#' + id"
                            v-model="record.unpostedFeeBackgroundColor"
                            :error="errors.unpostedFeeBackgroundColor"/>
                        </div>

                        <div class="form-group row">
                            <text-input
                            _class="col-md-8" 
                            label="Unposted Disbursements"
                            name="unpostedDisbursementBackgroundColor"
                            popOver="<h4>Unposted Disbursements</h4>
                                <p>You can set a <em>color</em> for Fee Notes which are <em><strong>Disbursements</strong></em> and have not been allocated to an Invoice, i.e. they are <strong>unposted</strong>.</p>
                                <p>Unposted Disbursements will then be displayed in this color which makes it easy to differentiate Disbursements from Fees and which have, and have not, been posted.</p>"
                            :popOverContainer="'#' + id"
                            v-model="record.unpostedDisbursementBackgroundColor"
                            :error="errors.unpostedDisbursementBackgroundColor"/>
                        </div>
                        

                        <div class="form-group row">
                            <text-input
                            _class="col-md-8" 
                            label="Posted Fees"
                            name="postedFeeBackgroundColor"
                            popOver="<h4>Posted Fees</h4>
                                <p>You can set a <em>color</em> for Fee Notes which are <em><strong>Fees</strong></em> and have been allocated to an Invoice, i.e. they have been <strong>posted</strong>.</p>
                                <p>These Fee Notes will then be displayed in this color which makes it easy to differentiate Fees from Disbursements and which have, and have not, been posted.</p>"
                            :popOverContainer="'#' + id"
                            v-model="record.postedFeeBackgroundColor"
                            :error="errors.postedFeeBackgroundColor"/>
                        </div>
                        
                        <div class="form-group row">
                            <text-input
                            _class="col-md-8" 
                            label="Posted Disbursements"
                            name="postedDisbursementBackgroundColor"
                            popOver="<h4>Posted Disbursements</h4>
                                <p>You can set a <em>color</em> for Fee Notes which are <em><strong>Disbursements</strong></em> and have been allocated to an Invoice, i.e. they have been <strong>posted</strong>.</p>
                                <p>Posted Disbursements will then be displayed in this color which makes it easy to differentiate Disbursements from Fees and which have, and have not, been posted.</p>"
                            :popOverContainer="'#' + id"
                            v-model="record.postedDisbursementBackgroundColor"
                            :error="errors.postedDisbursementBackgroundColor"/>
                        </div>
                    </fieldset>

                </div>
                <div class="col-xxl-6 mt-xxl-0 mt-xl-3">

                    <fieldset style="background: lightgrey;" class="mt-2"><legend>Reminders</legend>

                        <div class="form-group row">
                            <text-input
                            _class="col-md-8" 
                            label="Incomplete Reminders"
                            name="incompleteReminderBackgroundColor"
                            popOver="<h4>Incomplete Reminders</h4>
                                <p>You can set a <em>color</em> for Reminders which have not been completed.</p>
                                <p>These Reminders will then be displayed in this color which makes it easy to differentiate between incomplete and completed Reminders.</p>"
                            :popOverContainer="'#' + id"
                            v-model="record.incompleteReminderBackgroundColor"
                            :error="errors.incompleteReminderBackgroundColor"/>
                        </div>
                        <div class="form-group row">
                            <text-input
                            _class="col-md-8" 
                            label="Completed Reminders"
                            name="completedReminderBackgroundColor"
                            popOver="<h4>Completed Reminders</h4>
                                <p>You can set a <em>color</em> for Reminders which have been completed.</p>
                                <p>These Reminders will then be displayed in this color which makes it easy to differentiate between incomplete and completed Reminders.</p>"
                            :popOverContainer="'#' + id"
                            v-model="record.completedReminderBackgroundColor"
                            :error="errors.completedReminderBackgroundColor"/>
                        </div>
                    </fieldset>


                </div>
            </div>
        </div>

        <div v-show="activeTab === 'Email'" class="form-tab-content">
            <div class="row">

                <div class="col-xxl-6 mt-xxl-0 mt-xl-3">

                    <fieldset  style="background: lightgrey;" class="mt-3"><legend>Outgoing (SMTP) Server</legend>

                        <div class="form-group row">
                            <text-input 
                            _class="col-md-12" 
                            popOver="<h4>SMTP Server</h4>
                            <p>To send mail from Ettorney on your behalf, you need to specify the name of the SMTP Server your Company uses to send email.</p>
                            <p>You can get these details from your It dept, hosting company or by examining the settings you use in the email client you normally use to send email.</p>
                            "
                            :popOverContainer="'#' + id"
                            v-model="record.smtpServer" 
                            name="smtpServer" 
                            label="Server" 
                            :error="errors.smtpServer"/>
                        </div>

                        <div class="form-group row">
                            <text-input 
                            _class="col-md-6" 
                            popOver="<h4>SMTP Port</h4>
                            <p>An SMTP server will listen for incoming mail on a particular port.</p>
                            <p>This is typically 587, 465 or 25 but you can get these details from your It dept, hosting company or by examining the settings you use in the email client you normally use to send email.</p>
                            "
                            :popOverContainer="'#' + id"
                            v-model="record.smtpPort" 
                            name="smtpPort" 
                            label="Port" 
                            :error="errors.smtpPort"/>

                            <div class="col-md-6" style="align-self: flex-end;">

                                <button 
                                    :id="id + '-gmail-help-button'" 
                                    class="btn btn-danger form-button mb-1" 
                                    type="button" 
                                    @click="showGmailHelp"
                                >
                                <span title="Help on setting up access to a Gmail account">
                                    <i class="fa fa-question-circle fa-lg mr-2"></i>
                                    Gmail Help
                                </span>
                                </button>

                            </div>

                        </div>

                        <div class="form-group row">
                            <radio-buttons 
                                popOver="<h4>Encryption</h4>
                                    <p>Most Email Servers use either SSL or TLS (the latest) encryption.</p>
                                    <p>Before encryption was standard, many connections between an email client and the server were done insecurely. 
                                    This put personal information sent via email in danger of being intercepted and stolen. 
                                    Encyption reduces this risk by encrypting (or scrambling) the message when it is sent from the Email server to Ettorney.
                                    </p>
                                    <p>If your SMTP server uses encryption, specify the type of encryption it uses.</p>"
                                :popOverContainer="'#' + id"
                                _class="col-md-12" 
                                :record="record" 
                                column="smtpEncryption" 
                                name="smtpEncryption" 
                                :buttons="[
                                    {value:'None', text: 'None'},
                                    {value:'tls', text: 'TLS'},
                                    {value:'ssl', text: 'SSL'},
                                ]" 
                                label="Encryption" 
                                :error="errors.smtpEncryption"
                            />
                        </div>

                        <div class="form-group row">
                            <radio-buttons 
                                popOver="<h4>Authentication</h4>
                                    <p>Typically an Email Server requires a user to login to the server to send and receive email messages.</p>
                                    <p>If your server requires authentication, each Employee must have an SMTP username and password.</p>
                                    <p>Your user name and password can be specified below, but you must go to <em>Employees</em> and enter the SMTP username and password for each Employee (so they can send email messages using their credentials).</p>"
                                :popOverContainer="'#' + id"
                                _class="col-md-12" 
                                :record="record" 
                                column="smtpAuthentication" 
                                name="smtpAuthentication" 
                                :buttons="[
                                    {value:'Yes', text: 'Yes'},
                                    {value:'No', text: 'No'},
                                ]" 
                                label="Authentication" 
                                :error="errors.smtpAuthentication"
                                @change="authenticationChanged"
                            />
                        </div>

                        <div v-if="record.smtpAuthentication === 'Yes'" class="form-group row">
                            <text-input _class="col-md-12" 
                                popOver="<h4>User Name</h4>
                                <p>To login to the the Email Server, you need to provide a user name and password.</p>
                                <p>The user name is often just your email addres, but you can get these details from your It dept, hosting company or by examining the settings you use in the email client you normally use to send email.</p>
                                "
                                :popOverContainer="'#' + id"
                                v-model="employee.smtpUserName" 
                                name="smtpUserName" 
                                label="User Name"
                                @change="smptLoginDetailsChanged"
                            />
                        </div>

                        <div v-if="record.smtpAuthentication === 'Yes'" class="form-group row">
                            <text-input _class="col-md-12" 
                                v-model="employee.smtpPassword" 
                                name="smtpPassword" 
                                label="Password"
                                @change="smptLoginDetailsChanged" 
                            />
                        </div>


                        <div class="text-right">
                            <button v-show="record.smtpServer" 
                                :id="id + '-test-outgoing-email-button'" 
                                class="btn btn-danger form-button mt-1" 
                                type="button" 
                                @click="testOutgoingServer"
                            >
                            <span title="Check if you can login to the Outgoing Email Server">
                                <i class="fa fa-cog fa-lg mr-2"></i>Test Connection
                            </span>
                            </button>
                        </div>


                    </fieldset>

                </div>

                <div class="col-xxl-6 mt-xxl-0 mt-xl-3">

                    <fieldset  style="background: lightgrey;" class="mt-3"><legend>Incoming (IMAP) Server</legend>

                        <div class="form-group row">
                            <text-input 
                            _class="col-md-12" 
                            popOver="<h4>Incoming Server</h4>
                            <p>To import emails into Ettorney, you need to specify the name of the Email Server your Company uses to receive emails.</p>
                            <p>Ettorney uses the Imap protocol to retrieve messages so please ensure Imap is enabled on the Email Server (although it usually is by default).</p>
                            <p>You can get these details from your It dept, hosting company or by examining the settings you use in you email client.</p>
                            "
                            :popOverContainer="'#' + id"
                            v-model="record.incomingServer" 
                            name="incomingServer" 
                            label="Server" 
                            :error="errors.incomingServer"/>
                        </div>

                        <div class="form-group row">
                            <text-input 
                            _class="col-md-6" 
                            popOver="<h4>Type</h4>
                            <p>An email server will listen for requests to retrieve mail on a particular port.</p>
                            <p>This is typically 993 or 995 but you can get these details from your It dept or hosting company.</p>
                            "
                            :popOverContainer="'#' + id"
                            v-model="record.incomingPort" 
                            name="incomingPort" 
                            label="Port" 
                            :error="errors.incomingPort"/>
                        </div>

                        <div class="form-group row">
                            <radio-buttons 
                                popOver="<h4>Encryption</h4>
                                    <p>An Email Server typically requires some form of encryption on the incoming ports 993 or 995.</p>
                                    <p>Most Email Servers use SSL encryption.</p>
                                    <p>Before encryption was standard, many connections between an email client and the server were done insecurely. 
                                    This put personal information sent via email in danger of being intercepted and stolen. 
                                    Encyption reduces this risk by encrypting (or scrambling) the message when it is sent from the Email server to Ettorney.
                                    </p>
                                    <p>If your incoming email server uses encryption, specify the type of encryption it uses.</p>"
                                :popOverContainer="'#' + id"
                                _class="col-md-12" 
                                :record="record" 
                                column="incomingEncryption" 
                                name="incomingEncryption" 
                                :buttons="[
                                    {value:'None', text: 'None'},
                                    {value:'ssl', text: 'SSL'},
                                    {value:'tls', text: 'TLS'},
                                ]" 
                                label="Encryption" 
                                :error="errors.incomingEncryption"
                            />
                        </div>

                        <div class="text-right">
                            <button v-show="record.incomingServer" 
                            :id="id + '-test-incoming-email-button'" 
                            class="btn btn-danger form-button mt-1" 
                            type="button" 
                            @click="testIncomingServer"
                            >
                            <span title="Check if you can login to the Incoming Email Server">
                                <i class="fa fa-cog fa-lg mr-2"></i>Test Connection</span>
                            </button>
                        </div>


                    </fieldset>

                </div>
            </div>
        </div>

        <div v-show="activeTab === 'Advanced'" class="form-tab-content">
            <div class="row">
                <div class="col-lg-6">
                
                    <fieldset style="background: lightgrey;" class="mt-2"><legend>Locale Settings</legend>

                        <div class="form-group row">
                            <div class="col-lg-12">
                                <label>Date Format</label>
                                <select class="form-control" name="date-format" v-model="record.dateFormat" title="The format dates are displayed in"> 
                                    <option value="DD MMM YYYY" v-text="renderDate('DD MMM YYYY')"></option>
                                    <option value="DD-MM-YYYY" v-text="renderDate('DD-MM-YYYY')"></option>
                                    <option value="DD/MM/YYYY" v-text="renderDate('DD/MM/YYYY')"></option>
                                    <option value="MM-DD-YYYY" v-text="renderDate('MM-DD-YYYY')"></option>
                                    <option value="MM/DD/YYYY" v-text="renderDate('MM/DD/YYYY')"></option>
                                    <option value="YYYY-MM-DD" v-text="renderDate('YYYY-MM-DD')"></option>
                                    <option value="YYYY/MM/DD" v-text="renderDate('YYYY/MM/DD')"></option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.currencySymbol" label="Currency Symbol" name="currencySymbol" :error="errors.currencySymbol"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.timeZone" label="Time Zone" name="timeZone" :error="errors.timeZone"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.countryCode" label="Country Code" name="countryCode" :error="errors.countryCode"/>
                        </div>

                        <div class="form-group row">
                            <text-input _class="col-md-12" v-model="record.currencyCode" label="Currency Code" name="currencyCode" :error="errors.currencyCode"/>
                        </div>

                        <div class="form-group row">
                            <div class="col-lg-12">
                                <label>Paper Size</label>
                                <select class="form-control" name="paper-size" v-model="record.paperSize" title="The paper size of the documents generated by the program"> 
                                    <option value="A4">A4</option>
                                    <option value="Letter">Letter</option>
                                    <option value="Legal">Legal</option>
                                    <option value="Ledger">Ledger</option>
                                    <option value="Tabloid">Tabloid</option>
                                    <option value="A3">A3</option>
                                    <option value="B5">B5</option>
                                    <option value="B4">B4</option>
                                    <option value="B3">B3</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group row">
                            <div class="col-lg-12">
                                <label>Region</label>
                                <select class="form-control" v-model="record.region" title="The AWS region used by this Company to store data"> 
                                    <option value="us-east-1">us-east-1</option>
                                    <option value="us-west-1">us-west-1</option>
                                    <option value="af-south-1">af-south-1</option>
                                    <option value="eu-west-2">eu-west-2</option>
                                    <option value="ap-southeast-2">ap-southeast-2</option>
                                    <option value="ca-central-1">ca-central-1</option>
                                </select>
                            </div>
                        </div>


                    </fieldset>

                </div>
                <div class="col-lg-6">

                    <div class="program-icon" @click="showPage('ImportData')">
                        <img src="/icons/import.png">
                        <div class="program-icon-text">Import Data</div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <form-buttons :viewing="true" :editing="false"  record="Company details" @ok-clicked="submitForm" @cancel-clicked="hide"/>

</div>

</template>

<script>

import vueDropzone from "vue2-dropzone";

export default {

    components: {
        logoDropzone: vueDropzone,
        letterheadDropzone: vueDropzone,
    },

    data() {
        return {
            id: 'setup-company',
            initializedColorPickers: false,
            activePage: 'Company',
            activeTab: null,
            record: {},
            employee: {}, 
            errors: {},
            logoDropOptions: {
                url: "/file/selected",
                maxFilesize: 5, // 5MB
                thumbnailWidth: 600,
                thumbnailMethod: 'contain',
                acceptedFiles: 'image/*'
            },
            letterHeadPdfFile: null,

            letterHeadDropOptions: {
                url: "/file/selected",
                maxFilesize: 5, // 5MB
                createImageThumbnails: false,
                acceptedFiles: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            },
            tabs: [
                {
                    pageName: "General",
                    title: "General",
                    iconClass: '',
                    visible: true,
                    active: true,
                },
                {
                    pageName: "LetterHead",
                    title: "Letterhead",
                    iconClass: '',
                    visible: true,
                    active: false,
                },
                {
                    pageName: "Logo",
                    title: "Logo",
                    iconClass: '',
                    visible: true,
                    active: false,
                },
                {
                    pageName: "Colors",
                    title: "Colors",
                    iconClass: '',
                    visible: true,
                    active: false,
                },
                {
                    pageName: "Email",
                    title: "Email",
                    iconClass: '',
                    visible: true,
                    active: false,
                },
                {
                    pageName: "Advanced",
                    title: "Advanced",
                    iconClass: '',
                    visible: true,
                    active: false,
                },
            ]
        }
    },

    watch: {
        
        activeTab(newValue) {

            $('#' + this.id + ' .popover-icon').popover();

            if ( newValue === "LetterHead") {

                this.letterHeadPdfFile = root.lolSettings.letterheadpdffile;

            } else if ( newValue === "Email") {

                this.employee = root.currentEmployee;

            } else if ( newValue === "Colors") {

                if ( this.initializedColorPickers ) return;

                let huebeeOptions = { shades: 10, saturations:1 };

                var elem = $('#' + this.id + ' input[name="unpostedFeeBackgroundColor"]')[0];
                this.unpostedFeeColorPicker = new Huebee( elem , huebeeOptions);
                this.unpostedFeeColorPicker.on( 'change', ( color, hue, sat, lum ) => {
                    this.record.unpostedFeeBackgroundColor = color;
                    this.record.unpostedFeeTextColor = $('#' + this.id + ' input[name="unpostedFeeBackgroundColor"]').css('color') === 'rgb(34, 34, 34)' ? '#222' : '#FFF';
                });

                elem = $('#' + this.id + ' input[name="postedFeeBackgroundColor"]')[0];
                this.postedFeeColorPicker = new Huebee( elem , huebeeOptions );
                this.postedFeeColorPicker.on( 'change', ( color, hue, sat, lum ) => {
                    this.record.postedFeeBackgroundColor = color;
                    this.record.postedFeeTextColor = $('#' + this.id + ' input[name="postedFeeBackgroundColor"]').css('color') === 'rgb(34, 34, 34)' ? '#222' : '#FFF';
                });

                elem = $('#' + this.id + ' input[name="unpostedDisbursementBackgroundColor"]')[0];
                this.unpostedDisbursementColorPicker = new Huebee( elem , huebeeOptions );
                this.unpostedDisbursementColorPicker.on( 'change', ( color, hue, sat, lum ) => {
                    this.record.unpostedDisbursementBackgroundColor = color;
                    this.record.unpostedDisbursementTextColor = $('#' + this.id + ' input[name="unpostedDisbursementBackgroundColor"]').css('color') === 'rgb(34, 34, 34)' ? '#222' : '#FFF';
                });

                elem = $('#' + this.id + ' input[name="postedDisbursementBackgroundColor"]')[0];
                this.postedDisbursementColorPicker = new Huebee( elem , huebeeOptions );
                this.postedDisbursementColorPicker.on( 'change', ( color, hue, sat, lum ) => {
                    this.record.postedDisbursementBackgroundColor = color;
                    this.record.postedDisbursementTextColor = $('#' + this.id + ' input[name="postedDisbursementBackgroundColor"]').css('color') === 'rgb(34, 34, 34)' ? '#222' : '#FFF';
                });

                elem = $('#' + this.id + ' input[name="incompleteReminderBackgroundColor"]')[0];
                this.incompleteReminderColorPicker = new Huebee( elem , huebeeOptions );
                this.incompleteReminderColorPicker.on( 'change', ( color, hue, sat, lum ) => {
                    this.record.incompleteReminderBackgroundColor = color;
                    this.record.incompleteReminderTextColor = $('#' + this.id + ' input[name="incompleteReminderBackgroundColor"]').css('color') === 'rgb(34, 34, 34)' ? '#222' : '#FFF';
                });

                elem = $('#' + this.id + ' input[name="completedReminderBackgroundColor"]')[0];
                this.completedReminderColorPicker = new Huebee( elem , huebeeOptions );
                this.completedReminderColorPicker.on( 'change', ( color, hue, sat, lum ) => {
                    this.record.completedReminderBackgroundColor = color;
                    this.record.completedReminderTextColor = $('#' + this.id + ' input[name="completedReminderBackgroundColor"]').css('color') === 'rgb(34, 34, 34)' ? '#222' : '#FFF';
                });


                this.initializedColorPickers = true;

            }

        },

        letterHeadPdfFile: function(newValue) {

            $('#setup-company-letterhead-pdf-iframe')[0].src = '';

            if ( newValue ) {
                setTimeout(() => {
                    
                    $('#setup-company-letterhead-pdf-iframe')[0].src = newValue;
                    
                });
            }
            
        }

    },

    methods: {

        smptLoginDetailsChanged() {

            axios.post('/employees/saveSmtpDetails', this.employee)
            
            .then(response => {

                if (response.data.error) { 
                    showError( 'Error', response.data.error);
                }

            }).catch(error => { 

                showError('Error',error);

            });

        },

        authenticationChanged() {   

            // Make sure the pop up works when this is unhidden
            if (this.record.smtpAuthentication === 'Yes') {
                setTimeout(() => {
                    $('#' + this.id + ' .popover-icon').popover();
                }, 1000);
            }
        },


        testIncomingServer() {

            if ( this.record.smtpAuthentication === 'Yes' && (!this.employee.smtpUserName || !this.employee.smtpPassword) ) {

                showError('Email Server Login Details Required','<p>Please insert your User Name and Password and try again.</p>');
                
            } else {

                let params = {
                    incomingServer: this.record.incomingServer,
                    incomingPort: this.record.incomingPort,
                    incomingEncryption: this.record.incomingEncryption,
                    userName: this.employee.smtpUserName,
                    password: this.employee.smtpPassword,
                };

                this.testIncomingMailServer( params );

            }
        },

        testIncomingMailServer( params ) {

            root.$snotify.simple('Checking incoming server', 'Please wait...', { timeout: 0, icon: 'img/cogs.gif' });

            axios.post('/mail/testIncomingServer',params)

            .then(response => {

                root.$snotify.clear();

                if (response.data.error) {

                    showError('Email Server Error',response.data.error);

                } else {

                    root.$snotify.simple('Connected to Incoming Email Server', 'Success', { timeout: 3000, icon: 'img/check.png' });

                }

            }).catch(error => { 

                showError('Error',error);

            });

        },

        testOutgoingServer() {

            if ( this.record.smtpAuthentication === 'Yes' && (!this.employee.smtpUserName || !this.employee.smtpPassword) ) {

                showError('Email Server Login Details Required','<p>Please insert your User Name and Password and try again.</p>');

            } else {

                axios.get('/employees/get-current')

                .then(response => {

                    let params = {
                        smtpServer: this.record.smtpServer,
                        smtpPort: this.record.smtpPort,
                        smtpEncryption: this.record.smtpEncryption,
                        smtpUserName: this.employee.smtpUserName,
                        smtpPassword: this.employee.smtpPassword,
                        email: response.data.email,
                        name: response.data.name,
                    };

                    this.testOutgoingMailServer( params );

            }).catch(error => { 

                showError('Error',error);

            });


            }


        },


        testOutgoingMailServer( params ) {

                root.$snotify.simple('Sending test email to ' + params.email, 'Please wait...', { timeout: 0, icon: 'img/cogs.gif' });

                axios.post('/mail/testOutgoingServer',params)

                .then(response => {

                    root.$snotify.clear();

                    if (response.data.error) {

                        showError('Email Server Error',response.data.error);

                    } else {

                        root.$snotify.simple('A test message was sent to ' + params.email + '. Check your inbox to see if you received the email.', 'Sent Email', { timeout: 3000, icon: 'img/check.png' });

                    }

            }).catch(error => { 

                showError('Error',error);

            });

        },

        showGmailHelp() {

            axios.post('/help/get', {
                fileName: 'gmail_imap.html'
            })

            .then(response => {

                if (response.data.error) {

                    showError('An error was encountered retrieving a help file',response.data.error);

                } else {

                    showHelp('Setting up email access to a Gmail account', response.data.contents);//, sizeClass);

                }
            }).catch(error => { 

                showError('Error',error);

            });

        },


        async letterHeadUploaded(file) {


            this.letterHeadPdfFile = '';// Clear this in case they upload the same file name

            var formData = new FormData();

            formData.append("file", file);
            formData.append("fileName", file.name);
            formData.append("folder", 'letterhead');

            let response = await axios.post('/file/upload', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            if (response.data.error) {

                showError('Error uploading document',response.data.error);

            } else {

                root.lolSettings.letterheadfilename = response.data.url;

                const convertOptions = {
                    destinationPath: 'letterhead',
                    docxFileName: file.name,
                    source: response.data.url,
                    sourceLocation: 'cloud',
                };

                let convertResponse = await convertToPdf(convertOptions);

                if ( convertResponse.error ) {

                    showError('PDF Conversion Error',convertResponse.error);

                } else {

                    root.lolSettings.letterheadpdffile = this.letterHeadPdfFile = convertResponse.url;

                    this.storeLetterHead();

                }

            }

        },

        storeLetterHead() {

            axios.post('/lolsettings/update', {
                recordid: root.lolSettings.recordid,
                letterheadfilename: root.lolSettings.letterheadfilename,
                letterheadpdffile: root.lolSettings.letterheadpdffile,
            })

            .then(response => {

                if (response.data.errors) {

                    showError('Error saving letterhead',response.data.errors);

                } else {

                    root.lolSettings = this.$root.lolSettings = response.data.data[0];

                }

            }).catch(error => { 

                showError('Error',error);

            });

        },

        downloadLetterHead() {

            root.downloadObject(root.lolSettings.letterheadfilename,'application/vnd.openxmlformats-officedocument.wordprocessingml.document');

        },


        replaceLetterHead() {

            this.deleteLetterHead();

            $('#company-letterhead-drop-zone-component').click();

        },

        deleteLetterHead() {

            this.$refs['company-letterhead-drop-zone-component'].removeAllFiles();

            root.lolSettings.letterheadfilename = null;
            root.lolSettings.letterheadpdffile = this.letterHeadPdfFile = null;

            this.storeLetterHead();

        },

        letterHeadUploadError(file, message, xhr)  {

            showError('Error uploading letterhead', message);

            this.$refs['company-letterhead-drop-zone-component'].removeAllFiles();

        },

        logoUploaded(file) {

            var formData = new FormData();

            formData.append("file", file);
            formData.append("fileName", file.name);
            formData.append("folder", 'logo');

            axios.post('/file/upload', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })

            .then(response => {

                if (response.data.error) {

                    showError('Error uploading logo',response.data.error);

                } else {

                    root.$snotify.success('Logo uploaded successfully');

                    axios.post('/lolsettings/update', {
                        recordid: root.lolSettings.recordid,
                        logo: response.data.url,
                    })

                    .then(response => {

                        if (response.data.errors) {

                            showError('Error saving logo',response.data.errors);

                        } else {

                            root.lolSettings = this.$root.lolSettings = response.data.data[0];

                        }
                    });

                }

            }).catch(error => { 

                showError('Error',error);

            });

        },

        replaceLogo() {

            this.deleteLogo();

            $('#company-logo-drop-zone-component').click();

        },

        deleteLogo() {

            this.$refs['company-logo-drop-zone-component'].removeAllFiles();
            this.record.logo = root.lolSettings.logo = this.$root.lolSettings.logo = null;

        },

        logoUploadError(file, message, xhr)  {

            showError('Error uploading logo', message);

            this.$refs['company-logo-drop-zone-component'].removeAllFiles();

        },


        renderDate(format) {

            return format + ' (' + moment().format(format) + ')';

        },

        submitForm() {

            axios.post('/lolsettings/update', this.record)

            .then(response => {

                if (response.data.errors) {

                    showError('Error saving Settings',response.data.errors);

                } else {

                    root.$snotify.success('The Settings were updated successfully');

                    root.lolSettings = this.$root.lolSettings = response.data.data[0];

                }

            }).catch(error => { 

                showError('Error',error);

            });

        },

        hide() {

            this.$root.$refs['right-hand-tab-container'].$refs['right-hand-tabs'].closePage(this.activePage);

        },


    },    

}
</script>

<style src='vue2-dropzone/dist/vue2Dropzone.min.css'></style>
